<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<title>å¾®ç”Ÿç‰©é†«æª¢å¸«å†’éšªï¼šè‡¨åºŠé‘‘å®šæ¨™æº–ç‰ˆ 2.3</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

<style>
:root{--bg:#0f172a;--card:#1e293b;--accent:#3b82f6;--text:#f8fafc;--border:#334155}
body{margin:0;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:var(--bg);color:var(--text);line-height:1.6; overflow-x: hidden;}
.app{display:flex;gap:20px;padding:20px;max-width:1400px;margin:0 auto}
#main{flex:3}
#sidebar{flex:1;max-width:380px}
.card{background:var(--card);padding:24px;border-radius:12px;border:1px solid var(--border);box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);margin-bottom:16px}
h1, h2, h3{margin-top:0;color:#60a5fa}
button{margin:8px 8px 8px 0;padding:10px 18px;border-radius:8px;border:none;background:var(--accent);color:white;cursor:pointer;font-weight:600;transition:all 0.2s}
button:hover:not(:disabled){background:#2563eb;transform:translateY(-1px)}
button.secondary{background:#10b981}
button.danger{background:#ef4444}
button:disabled{background:#475569;color:#94a3b8;cursor:not-allowed; transform: none !important;}
.small{font-size:0.875rem;color:#94a3b8}
#scoreBarContainer{width:100%;background:#334155;border-radius:10px;overflow:hidden;height:24px;margin-bottom:8px}
#scoreBar{height:24px;width:100%;background:linear-gradient(90deg,#22c55e,#eab308,#ef4444);color:#fff;text-align:center;line-height:24px;font-weight:700;transition:width 0.5s}
pre#memory{white-space:pre-wrap;font-family:inherit;background:#0f172a;padding:12px;border-radius:6px;font-size:0.9rem;border:1px solid var(--border);max-height:300px;overflow-y:auto}
.option-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(130px, 1fr));gap:10px;margin:15px 0}
.checkbox-item{display:flex;align-items:center;background:#334155;padding:8px;border-radius:6px;cursor:pointer;font-size: 0.9rem;}
.checkbox-item input{margin-right:8px}

#notification-overlay {
    position: fixed;
    top: 20%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 9999;
    padding: 20px 40px;
    border-radius: 12px;
    font-size: 1.25rem;
    font-weight: bold;
    color: white;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    display: none;
    animation: fadeInOut 2s forwards;
}
@keyframes fadeInOut {
    0% { opacity: 0; transform: translate(-50%, -60%); }
    15% { opacity: 1; transform: translate(-50%, -50%); }
    85% { opacity: 1; transform: translate(-50%, -50%); }
    100% { opacity: 0; transform: translate(-50%, -40%); }
}

.image-viewer {
    margin-top: 15px; padding: 10px; background: #000; border-radius: 8px; text-align: center; border: 2px solid var(--accent); display: none;
}
.image-viewer img { max-width: 100%; max-height: 300px; border-radius: 4px; object-fit: contain; }
.case-summary { background: #0f172a; padding: 15px; border-radius: 8px; border-left: 4px solid var(--accent); margin-bottom: 20px; }
.specimen-tag { display: inline-block; background: #60a5fa; color: #0f172a; padding: 4px 10px; border-radius: 4px; font-weight: bold; margin-bottom: 10px; }
.result-img { width: 100%; max-width: 500px; border-radius: 12px; margin: 15px 0; border: 3px solid var(--accent); }
#leaderboardTable { width: 100%; border-collapse: collapse; margin-top: 15px; }
#leaderboardTable th, #leaderboardTable td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); }
#leaderboardTable th { color: #60a5fa; }
input[type="text"] { background: #0f172a; color: white; border: 1px solid var(--border); padding: 8px; border-radius: 4px; margin-right: 8px; }
</style>
</head>
<body>

<div id="notification-overlay"></div>

<div class="app">
  <div id="main">
    <h1>ğŸ”¬ å¾®ç”Ÿç‰©é†«æª¢å¸«å†’éšª (æ¨™æº–ç‰ˆ 2.3)</h1>

    <div id="startCard" class="card">
      <h2>å°ˆæ¥­ç”Ÿæ¶¯æ¨¡å¼</h2>
      <p>åˆ†æ•¸æœƒè·¨ç—…æ¡ˆç´¯ç©ã€‚æŒ‘æˆ°åœ¨æœ‰é™çš„åˆ†æ•¸å…§é‘‘å®šæ‰€æœ‰ç—…æ‚£ã€‚</p>
      <button id="startBtn">é–‹å§‹åŸ·æ¥­</button>
      <button id="viewLeaderboardBtn" class="secondary">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
    </div>

    <div id="gameArea"></div>
  </div>

  <div id="sidebar">
    <div class="card">
      <h3>ğŸ¥ å°ˆæ¥­æŒ‡æ¨™</h3>
      <div id="scoreBarContainer">
        <div id="scoreBar">100</div>
      </div>
      <div class="small">ç´¯ç©æ²»ç™’ç—…æ‚£ï¼š<span id="correctCount" style="color:#10b981;font-weight:bold">0</span></div>
      <div class="small">ç¸½è¨ˆåŸ·æ¥­æ™‚é–“ï¼š<span id="timer">0</span> ç§’</div>
    </div>

    <div class="card">
      <h3>ğŸ“’ å›æ†¶ç´€éŒ„</h3>
      <pre id="memory">ï¼ˆå°šæœªé–‹å§‹é‘‘å®š...ï¼‰</pre>
    </div>

    <div id="actionPanel" class="card" style="display:none">
      <h3>âš¡ è¡Œå‹•</h3>
      <button id="submitReportBtn" class="danger">æäº¤æœ€çµ‚å ±å‘Š</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'microbe-adventure-v2';

const IMG_SUCCESS = "https://raw.githubusercontent.com/BiteMachi/microbeMT-adventure/ec7121969adb29521a7de990b2fb47c82e58fc1e/MTsussces.jpg";
const IMG_FAIL = "https://raw.githubusercontent.com/BiteMachi/microbeMT-adventure/ec7121969adb29521a7de990b2fb47c82e58fc1e/MTfail.jpg";

let user = null;
onAuthStateChanged(auth, u => { user = u; });

async function ensureAuth() {
  if (user) return;
  if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
    await signInWithCustomToken(auth, __initial_auth_token);
  } else {
    await signInAnonymously(auth);
  }
}

const CATEGORIES = ["GPC", "GNC", "GPB", "GNB", "YEAST", "FUNGI"];
const SPECIES_MAP = {
  GNB: ["Escherichia coli", "Klebsiella pneumoniae", "Pseudomonas aeruginosa", "Salmonella enterica"],
  GPC: ["Staphylococcus aureus", "Streptococcus pyogenes"],
  GNC: ["Neisseria gonorrhoeae", "Moraxella catarrhalis"],
  GPB: ["Bacillus anthracis", "Listeria monocytogenes"],
  YEAST: ["Candida albicans"],
  FUNGI: ["Aspergillus fumigatus"]
};

const PATIENT_DATABASE = [
  {
    description: "56æ­²ã€å©¦äººã€è‡ªè¿°æ’å°¿å›°é›£ã€æ’å°¿æ™‚æœƒç—›ä¸”å°¿æ¶²æ··æ¿ã€‚",
    specimen: "å°¿æ¶² (Urine)",
    correctOrganism: "Escherichia coli",
    correctCategory: "GNB",
    correctMedia: ["BAP/EMB"],
    images: {
      colony: "https://raw.githubusercontent.com/BiteMachi/microbeMT-adventure/33ef8da8a06ecc9322425246ca823e2b54cb08f6/Ecolionbapemb.jpg",
      gram: "https://raw.githubusercontent.com/BiteMachi/microbeMT-adventure/19f8e3a2ee8c944744c92e55e9ba10f5d4db9b86/Ecoligramstain.jpg",
      biochem: "https://raw.githubusercontent.com/BiteMachi/microbeMT-adventure/ec7121969adb29521a7de990b2fb47c82e58fc1e/Ecoli%208%20bio02.jpg",
    }
  },
  {
    description: "22æ­²ã€ç”·æ€§ã€çš®è†šå‚·å£ç´…è…«åŒ–è†¿ï¼Œä¸¦æœ‰ç™¼ç‡’ç¾è±¡ã€‚",
    specimen: "è†¿æ¶² (Pus)",
    correctOrganism: "Staphylococcus aureus",
    correctCategory: "GPC",
    correctMedia: ["BAP"],
    images: {
      colony: "https://raw.githubusercontent.com/BiteMachi/microbeMT-adventure/33ef8da8a06ecc9322425246ca823e2b54cb08f6/SAonbap.jpg",
      gram: "https://raw.githubusercontent.com/BiteMachi/microbeMT-adventure/6b897dc4c948719b45d390cbf8599a6a9fe0e3de/GPCincluster.jpg",
      biochem: "https://placehold.co/400x300/334155/f8fafc?text=Catalase:+,Coagulase:+",
    }
  }
];

let globalScore = 100;
let curedCount = 0;
let totalTimer = 0;
let timerInterval = null;
let currentPatient = null;
let usedMethods = new Set();
let remainingCases = [];
let gramValidated = false;
let bioValidated = false;

function init() {
  document.getElementById('startBtn').onclick = startGame;
  document.getElementById('viewLeaderboardBtn').onclick = fetchAndShowLeaderboard;
  document.getElementById('submitReportBtn').onclick = showReportFinalSelection;
}

function showNotification(text, type = 'info') {
    const overlay = document.getElementById('notification-overlay');
    overlay.textContent = text;
    overlay.style.display = 'block';
    overlay.style.background = type === 'error' ? '#ef4444' : (type === 'success' ? '#10b981' : '#3b82f6');
    overlay.style.animation = 'none';
    overlay.offsetHeight; 
    overlay.style.animation = 'fadeInOut 2s forwards';
    setTimeout(() => { overlay.style.display = 'none'; }, 2000);
}

function startGame() {
  globalScore = 100; curedCount = 0; totalTimer = 0;
  remainingCases = [...PATIENT_DATABASE];
  document.getElementById('startCard').style.display = 'none';
  document.getElementById('actionPanel').style.display = 'block';
  startTimer();
  nextPatient();
}

function startTimer() {
  if(timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    totalTimer++;
    document.getElementById('timer').textContent = totalTimer;
  }, 1000);
}

function updateSidebar() {
  const bar = document.getElementById('scoreBar');
  const safeScore = Math.max(0, globalScore);
  bar.style.width = Math.min(100, safeScore) + "%";
  bar.textContent = safeScore;
  document.getElementById('correctCount').textContent = curedCount;
  if (globalScore <= 0) endGame("FAILED", "å°ˆæ¥­åˆ†æ•¸æ­¸é›¶ï¼Œä½ è¢«æ’¤éŠ·äº†é†«æª¢å¸«åŸ·ç…§ï¼");
}

function pushMemory(msg) {
  const m = document.getElementById('memory');
  m.textContent += msg + "\n";
  m.scrollTop = m.scrollHeight;
}

function changeScore(delta, reason) {
  globalScore += delta;
  pushMemory(`ç³»çµ±ï¼š${delta > 0 ? '+' : ''}${delta} åˆ† (${reason})`);
  showNotification(`${reason} (${delta > 0 ? '+' : ''}${delta}åˆ†)`, delta < 0 ? 'error' : 'success');
  updateSidebar();
}

function nextPatient() {
  if (remainingCases.length === 0) {
    endGame("SUCCESS", "æ­å–œï¼ä½ å·²å®Œæˆæ‰€æœ‰ç—…æ¡ˆé‘‘å®šã€‚");
    return;
  }
  const randIdx = Math.floor(Math.random() * remainingCases.length);
  currentPatient = remainingCases.splice(randIdx, 1)[0];
  usedMethods.clear();
  gramValidated = false;
  bioValidated = false;
  pushMemory("-----------------------");
  pushMemory(`ã€æ–°ç—…æ¡ˆã€‘ç³»çµ±æ´¾ä»¶ä¸­...`);
  updateSidebar();
  showStepCulture();
}

function showStepCulture() {
  const area = document.getElementById('gameArea');
  area.innerHTML = `
    <div class="card">
      <h2>æ­¥é©Ÿä¸€ï¼šé¸æ“‡åŸ¹é¤ŠåŸº</h2>
      <div class="case-summary">
        <span class="specimen-tag">æª¢é«”é¡åˆ¥ï¼š${currentPatient.specimen}</span><br>
        <strong>ğŸ“‹ ç—…æ­·æè¿°ï¼š</strong><br>${currentPatient.description}
      </div>
      <div class="option-grid" id="mediaGrid"></div>
      <button id="validateMediaBtn">ç¢ºèªæ¥ç¨®</button>
    </div>`;
  const mediaList = ["BAP", "EMB", "BAP/EMB", "CHO", "CHO/CNA", "SDA", "XLD"];
  const grid = document.getElementById('mediaGrid');
  mediaList.forEach(m => {
    grid.innerHTML += `<label class="checkbox-item"><input type="checkbox" value="${m}" class="media-cb"> ${m}</label>`;
  });
  document.getElementById('validateMediaBtn').onclick = validateMedia;
}

function validateMedia() {
  const selected = Array.from(document.querySelectorAll('.media-cb:checked')).map(el => el.value);
  if (selected.length === 0) return;
  const correct = currentPatient.correctMedia;
  if (selected.length === correct.length && selected.every(val => correct.includes(val))) {
    showNotification("åŸ¹é¤ŠåŸºçµ„åˆæ­£ç¢ºï¼", "success");
    pushMemory("é†«æª¢ç´€éŒ„ï¼šåŸ¹é¤ŠåŸºçµ„åˆæ­£ç¢ºã€‚");
    showStepIdentification();
  } else {
    changeScore(-10, "åŸ¹é¤ŠåŸºé¸æ“‡éŒ¯èª¤ï¼");
  }
}

function showStepIdentification() {
  const area = document.getElementById('gameArea');
  area.innerHTML = `
    <div class="card">
      <h2>æ­¥é©ŸäºŒï¼šå¾®ç”Ÿç‰©é‘‘å®š</h2>
      <div id="imageViewer" class="image-viewer" style="display: block;">
        <div id="imageTitle" class="image-title" style="color:#60a5fa;font-weight:bold;margin-bottom:5px">ğŸ§« èŒè½è§€å¯Ÿ</div>
        <img id="displayImg" src="${currentPatient.images.colony}" alt="å½±åƒ" style="max-width:100%; border-radius:4px">
      </div>
      <div id="identifyButtons" style="margin-top: 15px;">
        <button id="btn-gram">Gram stain</button>
        <button id="btn-mass">Mass spectrometry</button>
        <button id="btn-vitek">VITEK 2</button>
        <button id="btn-bio">å‚³çµ±ç”ŸåŒ–è©¦é©—</button>
      </div>
      <div id="gramSelectorArea"></div>
    </div>
  `;
  document.getElementById('btn-gram').onclick = handleGramStain;
  document.getElementById('btn-mass').onclick = handleMassSpec;
  document.getElementById('btn-vitek').onclick = handleVitek;
  document.getElementById('btn-bio').onclick = handleBiochem;
  updateMethodButtons();
}

function updateMethodButtons() {
  document.getElementById('btn-gram').disabled = (usedMethods.has('gram') && gramValidated);
  document.getElementById('btn-mass').disabled = usedMethods.has('mass');
  document.getElementById('btn-vitek').disabled = usedMethods.has('vitek');
  document.getElementById('btn-bio').disabled = bioValidated;
}

function handleGramStain() {
  usedMethods.add('gram');
  document.getElementById('displayImg').src = currentPatient.images.gram;
  document.getElementById('imageTitle').textContent = "ğŸ”¬ Gram Stain å½±åƒè§€å¯Ÿ";
  const selectorArea = document.getElementById('gramSelectorArea');
  selectorArea.innerHTML = `
    <div class="card" style="margin-top:15px; background:#334155">
      <p>è«‹é¸æ“‡æ­£ç¢ºå‹æ…‹ï¼š</p>
      ${CATEGORIES.map(c => `<button class="secondary" onclick="window.validateGramType('${c}')">${c}</button>`).join('')}
    </div>`;
}

window.validateGramType = (selectedType) => {
  if (selectedType === currentPatient.correctCategory) {
    gramValidated = true;
    showNotification("å‹æ…‹åˆ¤è®€æ­£ç¢ºï¼", "success");
    pushMemory("é†«æª¢ç´€éŒ„ï¼šé‘‘å®šå‹æ…‹ç‚º " + selectedType);
    document.getElementById('gramSelectorArea').innerHTML = "";
    updateMethodButtons();
  } else {
    changeScore(-10, "å‹æ…‹åˆ¤è®€éŒ¯èª¤ã€‚");
  }
};

function handleMassSpec() {
  usedMethods.add('mass');
  if (Math.random() < 0.2) {
    changeScore(-20, "è³ªè­œå„€æ•…éšœï¼Œç„¡æ³•ç²å¾—çµæœã€‚");
  } else {
    showNotification("è³ªè­œé‘‘å®šå®Œæˆ", "success");
    pushMemory(`é‘‘å®šç´€éŒ„ï¼šè³ªè­œçµæœé¡¯ç¤ºç‚º ${currentPatient.correctOrganism}`);
  }
  updateMethodButtons();
}

function handleVitek() {
  usedMethods.add('vitek');
  if (Math.random() < 0.3) {
    changeScore(-20, "VITEK 2 é‘‘å®šç‡éä½ï¼Œç„¡æ³•ç¢ºèªã€‚");
  } else {
    showNotification("VITEK 2 é‘‘å®šå®Œæˆ", "success");
    pushMemory(`é‘‘å®šç´€éŒ„ï¼šVITEK 2 çµæœç‚º ${currentPatient.correctOrganism}`);
  }
  updateMethodButtons();
}

function handleBiochem() {
  document.getElementById('displayImg').src = currentPatient.images.biochem;
  document.getElementById('imageTitle').textContent = "ğŸ§ª ç”ŸåŒ–åæ‡‰ç®¡è§€å¯Ÿ";
  
  const area = document.getElementById('gameArea');
  if (document.getElementById('bio-card')) return;

  const card = document.createElement('div');
  card.className = "card"; card.id = "bio-card";
  card.innerHTML = `
    <h3>å‚³çµ±ç”ŸåŒ–åˆ¤è®€</h3>
    <p>è«‹ä¾æ“šä¸Šæ–¹åœ–ç‰‡åˆ¤è®€å¤§é¡ï¼š</p>
    <div id="bioControlArea">
      ${CATEGORIES.map(c => `<button onclick="window.validateBioCategory('${c}')">${c}</button>`).join('')}
    </div>`;
  area.appendChild(card);
}

window.validateBioCategory = (cat) => {
  if (cat === currentPatient.correctCategory) {
    showNotification("å¤§é¡åˆ¤è®€æ­£ç¢º", "success");
    const bioControlArea = document.getElementById('bioControlArea');
    bioControlArea.innerHTML = `
      <p>è«‹é¸æ“‡æœ€çµ‚é‘‘å®šèŒç¨®ï¼š</p>
      ${SPECIES_MAP[cat].map(s => `<button onclick="window.finishBioIdentification('${s}')">${s}</button>`).join('')}
    `;
  } else {
    changeScore(-30, "å¤§é¡é¸éŒ¯ï¼Œè©¦åŠ‘æµªè²»ï¼");
  }
};

window.finishBioIdentification = (name) => {
  if (name === currentPatient.correctOrganism) {
    bioValidated = true;
    showNotification("ç”ŸåŒ–é‘‘å®šæ­£ç¢ºï¼", "success");
    pushMemory(`é‘‘å®šç´€éŒ„ï¼šç”ŸåŒ–è©¦é©—ç¢ºèªç‚º ${name}`);
    showStepIdentification();
  } else {
    changeScore(-30, "ç”ŸåŒ–èŒç¨®åˆ¤å®šéŒ¯èª¤ã€‚");
  }
};

window.showReportFinalSelection = () => {
  const area = document.getElementById('gameArea');
  area.innerHTML = `<div class="card"><h2>ğŸ¥ æäº¤æœ€çµ‚å ±å‘Š</h2><p>âš ï¸ è«‹è¬¹æ…å‘ˆå ±ï¼ŒéŒ¯èª¤å°‡ç›´æ¥åŠéŠ·åŸ·ç…§ï¼š</p>
    ${CATEGORIES.map(c => `<button onclick="window.showFinalSpeciesList('${c}')">${c}</button>`).join('')}
    <br><button onclick="window.showStepIdentification()" style="background:#475569">è¿”å›</button></div>`;
};

window.showFinalSpeciesList = (cat) => {
  const area = document.getElementById('gameArea');
  area.innerHTML = `<div class="card"><h2>ğŸ¥ æœ€çµ‚å‘ˆå ± (${cat})</h2>
    ${SPECIES_MAP[cat].map(s => `<button onclick="window.finalizeGame('${s}')">${s}</button>`).join('')}
    <br><button onclick="window.showReportFinalSelection()" style="background:#475569">è¿”å›</button></div>`;
};

window.finalizeGame = (name) => {
  if (name === currentPatient.correctOrganism) {
    curedCount++;
    showNotification("è¨ºæ–·æ­£ç¢ºï¼ç—…æ‚£åº·å¾©ã€‚", "success");
    nextPatient();
  } else {
    endGame("FAILED", `è‡´å‘½é†«ç™‚ç–å¤±ï¼é‘‘å®šéŒ¯èª¤ï¼šæ­£ç¢ºæ‡‰ç‚º ${currentPatient.correctOrganism}ã€‚`);
  }
};

async function endGame(type, reason) {
  clearInterval(timerInterval);
  document.getElementById('actionPanel').style.display = 'none';
  const area = document.getElementById('gameArea');
  
  if (type === "SUCCESS") {
    area.innerHTML = `
      <div class="card" style="text-align:center; border:3px solid #10b981">
        <h1 style="color:#10b981">ğŸ† é‘‘å®šæˆåŠŸ</h1>
        <img src="${IMG_SUCCESS}" class="result-img">
        <p>${reason}</p>
        <p>æ²»ç™’ï¼š${curedCount} | è€—æ™‚ï¼š${totalTimer}ç§’</p>
        <div id="saveForm"><input type="text" id="playerName" placeholder="é†«æª¢å¸«å§“å"> <button id="saveBtn">ç™»éŒ„æˆç¸¾</button></div>
        <button onclick="location.reload()" class="secondary">è¿”å›é¸å–®</button>
      </div>`;
    document.getElementById('saveBtn').onclick = async () => {
      const name = document.getElementById('playerName').value.trim();
      if (!name) return;
      if (name === "HSU114608") { showAdminMenu(); return; }
      await ensureAuth();
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), {
        name, score: totalTimer, cured: curedCount, date: new Date().toISOString()
      });
      fetchAndShowLeaderboard();
    };
  } else {
    area.innerHTML = `
      <div class="card" style="text-align:center; border:3px solid #ef4444">
        <h1 style="color:#ef4444">ğŸ’€ åŸ·æ¥­çµ‚æ­¢</h1>
        <img src="${IMG_FAIL}" class="result-img">
        <p>${reason}</p>
        <button onclick="location.reload()">é‡æ–°é–‹å§‹</button>
      </div>`;
  }
}

async function fetchAndShowLeaderboard() {
  const area = document.getElementById('gameArea');
  document.getElementById('startCard').style.display = 'none';
  area.innerHTML = `<div class="card"><h2>ğŸ† å…¨çƒæ’è¡Œ (ä¾æ™‚é–“æ’åº)</h2><div id="lb-content">è¼‰å…¥ä¸­...</div><button onclick="location.reload()">è¿”å›</button></div>`;
  await ensureAuth();
  const q = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
  const snap = await getDocs(q);
  const data = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a, b) => a.score - b.score);
  let html = `<table id="leaderboardTable"><tr><th>åæ¬¡</th><th>å§“å</th><th>æ™‚é–“</th><th>æ²»ç™’æ•¸</th></tr>`;
  data.forEach((r, i) => html += `<tr><td>${i+1}</td><td>${r.name}</td><td>${r.score}s</td><td>${r.cured}</td></tr>`);
  document.getElementById('lb-content').innerHTML = data.length ? html + "</table>" : "å°šç„¡ç´€éŒ„ã€‚";
}

async function showAdminMenu() {
  const area = document.getElementById('gameArea');
  area.innerHTML = `
    <div class="card" style="border:2px solid #ef4444">
      <h2 style="color:#ef4444">ğŸ”§ ç®¡ç†æ¬Šé™é¸å–®</h2>
      <p>è«‹é¸æ“‡æ’è¡Œç¶­è­·å‹•ä½œï¼š</p>
      <button class="danger" id="clearAllBtn">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ’è¡Œ</button>
      <button class="secondary" id="keepTop50Btn">â­ ä¿ç•™å‰ 50 åï¼Œå…¶é¤˜æ¸…é™¤</button>
      <br><br>
      <button onclick="location.reload()" style="background:#475569">é€€å‡ºç®¡ç†æ¨¡å¼</button>
    </div>`;

  document.getElementById('clearAllBtn').onclick = async () => {
    if(!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ’è¡Œæ¦œè³‡æ–™å—ï¼Ÿæ­¤å‹•ä½œä¸å¯å¾©åŸã€‚")) return;
    await ensureAuth();
    const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'));
    await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
    showNotification("å·²æ¸…ç©ºæ‰€æœ‰æ’è¡Œ", "success");
    location.reload();
  };

  document.getElementById('keepTop50Btn').onclick = async () => {
    if(!confirm("ç¢ºå®šè¦ä¿ç•™å‰ 50 åä¸¦æ¸…ç©ºå…¶é¤˜è³‡æ–™å—ï¼Ÿ")) return;
    await ensureAuth();
    const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'));
    const allRecords = snap.docs.map(d => ({id: d.id, ...d.data(), ref: d.ref}));
    allRecords.sort((a, b) => a.score - b.score);
    const toDelete = allRecords.slice(50);
    if (toDelete.length === 0) {
      showNotification("è³‡æ–™é‡ä¸è¶³ 50 ç­†ï¼Œæœªé€²è¡Œåˆªé™¤ã€‚", "info");
      return;
    }
    await Promise.all(toDelete.map(d => deleteDoc(d.ref)));
    showNotification(`å·²æ¸…ç† ${toDelete.length} ç­†è³‡æ–™ï¼Œä¿ç•™å‰ 50 åã€‚`, "success");
    location.reload();
  };
}

init();
</script>
</body>
</html>